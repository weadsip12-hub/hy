<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>hy blog</title>
  <style>
    :root { --w: 920px; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial; background:#0b0f14; color:#e6edf3; }
    a { color:#79c0ff; text-decoration:none; }
    a:hover { text-decoration:underline; }
    header { padding: 32px 16px 12px; border-bottom:1px solid #1f2937; background:#0b0f14; position:sticky; top:0; z-index:10; }
    .wrap { max-width: var(--w); margin: 0 auto; }
    .title { display:flex; gap:12px; align-items:baseline; justify-content:space-between; }
    h1 { margin:0; font-size: 22px; letter-spacing:0.2px; }
    .sub { margin: 8px 0 0; color:#9aa4b2; font-size: 13px; }
    main { padding: 18px 16px 40px; }
    .controls { display:flex; gap:10px; margin: 14px 0 18px; }
    input { flex:1; padding: 10px 12px; border-radius:12px; border:1px solid #243041; background:#0f1722; color:#e6edf3; }
    .card { border:1px solid #1f2937; background:#0f1722; border-radius:16px; padding: 14px 14px; margin: 10px 0; }
    .meta { color:#9aa4b2; font-size: 12px; margin-top: 6px; display:flex; gap:10px; flex-wrap:wrap; }
    .badge { border:1px solid #2b3a51; color:#c9d1d9; padding:2px 8px; border-radius:999px; font-size: 11px; }
    .empty { color:#9aa4b2; padding: 18px 0; }
    footer { border-top:1px solid #1f2937; padding: 16px; color:#9aa4b2; font-size: 12px; }
    img { max-width: 100%; border-radius: 12px; border: 1px solid #1f2937; }
    pre { white-space:pre-wrap; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <h1><a href="./">hy blog</a></h1>
        <a href="https://github.com/weadsip12-hub/hy" target="_blank" rel="noreferrer">GitHub</a>
      </div>
      <p class="sub">posts.json을 읽어서 목록을 만들고, 클릭하면 마크다운을 불러오는 단순 블로그</p>

      <div class="controls">
        <input id="q" placeholder="검색 (제목/태그)" />
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="view"></div>
  </main>

  <footer>
    <div class="wrap">© hy • GitHub Pages</div>
  </footer>

<script>
  const view = document.getElementById('view');
  const q = document.getElementById('q');

  // ✅ 프로젝트 페이지 base: "/hy"
  const BASE = (() => {
    const parts = location.pathname.split('/').filter(Boolean);
    return parts.length ? `/${parts[0]}` : '';
  })();

  function esc(s){
    return (s||'').replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
  }

  function renderList(posts, keyword=''){
    const k = keyword.trim().toLowerCase();
    const filtered = posts.filter(p => {
      if(!k) return true;
      const hay = (String(p.title||'') + ' ' + (p.tags||[]).join(' ')).toLowerCase();
      return hay.includes(k);
    });

    if(filtered.length === 0){
      view.innerHTML = `<div class="empty">검색 결과가 없어.</div>`;
      return;
    }

    view.innerHTML = filtered.map(p => `
      <div class="card">
        <div>
          <a href="#/post/${encodeURIComponent(p.file)}"><strong>${esc(p.title || p.file)}</strong></a>
        </div>
        <div class="meta">
          <span>${esc(p.date || '')}</span>
          ${(p.tags||[]).map(t => `<span class="badge">${esc(t)}</span>`).join('')}
        </div>
        ${p.desc ? `<div class="meta">${esc(p.desc)}</div>` : ``}
      </div>
    `).join('');
  }

  async function loadPosts(){
    // ✅ 상대경로로 가져와야 /hy/에서도 안전
    const res = await fetch('./posts.json', { cache: 'no-store' });
    if(!res.ok) throw new Error(`posts.json을 못 불러왔어. status=${res.status}`);
    const posts = await res.json();

    // posts가 혹시 문자열로 섞여있으면 방어
    const fixed = [];
    for (const p of posts){
      if (p && typeof p === 'object') fixed.push(p);
    }

    fixed.sort((a,b) => String(b.date||'').localeCompare(String(a.date||'')));
    return fixed;
  }

  function normalizeMarkdown(md){
    // 0) front matter 제거
    md = md.replace(/^---[\s\S]*?---\s*/m, '');

    // 1) 너가 만든 깨진 이미지 문법 1차 복구: ![]((path)) -> ![](path)
    md = md.replace(/!\[([^\]]*)\]\(\(([^)]+)\)\)/g, '![$1]($2)');

    // 2) 이미지 링크 보정
    // - 상대경로 assets/... 이면 blog/assets/... 로 붙임
    // - /blog/... 이면 BASE(/hy) 붙임
    // - blog/... 이면 BASE(/hy) 붙임
    md = md.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (m, alt, path) => {
      const raw = (path || '').trim();

      // http/https는 건드리지 않음
      if (/^https?:\/\//i.test(raw)) return m;

      // 따옴표 제거
      let p = raw.replace(/^["']|["']$/g, '');

      // ./ 제거
      if (p.startsWith('./')) p = p.slice(2);

      // 절대경로 /blog/... -> /hy/blog/...
      if (p.startsWith('/blog/')) return `![${alt}](${BASE}${p})`;

      // 이미 blog/... 라면 -> /hy/blog/...
      if (p.startsWith('blog/')) return `![${alt}](${BASE}/${p})`;

      // assets/... 라면 실제는 blog/assets/...
      if (p.startsWith('assets/')) return `![${alt}](${BASE}/blog/${p})`;

      // 그 외: 그냥 BASE 붙여 상대경로로 해봄
      return `![${alt}](${BASE}/${p})`;
    });

    return md;
  }

  async function renderPost(file){
    // ✅ posts.json의 file은 "파일명" 형태(2026-...md)라고 가정
    const url = `${BASE}/blog/posts/${file}`;
    const res = await fetch(url, { cache: 'no-store' });

    if(!res.ok){
      view.innerHTML = `<div class="empty">포스트 파일을 못 불러왔어: ${esc(file)} (status=${res.status})<br/>URL: ${esc(url)}</div>`;
      return;
    }

    let md = await res.text();
    md = normalizeMarkdown(md);

    const html = marked.parse(md);

    view.innerHTML = `
      <div class="card">
        <div style="margin-bottom:10px;"><a href="#/">← 목록으로</a></div>
        <div>${html}</div>
      </div>
    `;
    window.scrollTo(0,0);
  }

  function getRoute(){
    const h = location.hash || '#/';
    const m = h.match(/^#\/post\/(.+)$/);
    return m ? { type:'post', file: decodeURIComponent(m[1]) } : { type:'list' };
  }

  let POSTS = [];

  async function router(){
    const route = getRoute();
    if(route.type === 'post'){
      await renderPost(route.file);
    } else {
      renderList(POSTS, q.value);
    }
  }

  (async () => {
    try{
      POSTS = await loadPosts();
      q.addEventListener('input', () => renderList(POSTS, q.value));
      window.addEventListener('hashchange', router);
      await router();
    } catch(e){
      view.innerHTML = `<div class="empty">${esc(e.message)}</div>`;
    }
  })();
</script>
</body>
</html>
