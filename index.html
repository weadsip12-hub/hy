<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>hy blog</title>

  <style>
    :root { --w: 860px; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial; background:#0b0f14; color:#e6edf3; }
    a { color:#79c0ff; text-decoration:none; }
    a:hover { text-decoration:underline; }
    header { padding: 28px 18px 14px; border-bottom:1px solid rgba(255,255,255,0.10); background: rgba(11,15,20,0.85); position:sticky; top:0; backdrop-filter: blur(10px); z-index:10;}
    .wrap { max-width: var(--w); margin: 0 auto; }
    .title { display:flex; gap:12px; align-items:center; justify-content:space-between; }
    h1 { margin:0; font-size: 22px; }
    .sub { margin: 8px 0 0; color:rgba(230,237,243,0.65); font-size: 13px; }
    main { padding: 18px 18px 40px; }
    .controls { display:flex; gap:10px; margin: 14px 0 18px; }
    input { flex:1; padding: 12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.03); color:#e6edf3; outline:none; }
    input:focus { border-color: rgba(121,192,255,0.55); box-shadow: 0 0 0 3px rgba(121,192,255,0.12); }
    .card { border:1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.04); border-radius:18px; padding: 16px 16px; margin: 12px 0; }
    .meta { color:rgba(230,237,243,0.65); font-size: 12px; margin-top: 8px; display:flex; gap:10px; flex-wrap:wrap; }
    .badge { border:1px solid rgba(121,192,255,0.25); background: rgba(121,192,255,0.08); padding:2px 9px; border-radius:999px; font-size: 11px; }
    .empty { color:rgba(230,237,243,0.65); padding: 18px 0; white-space: pre-wrap; }
    footer { border-top:1px solid rgba(255,255,255,0.10); padding: 16px 18px; color:rgba(230,237,243,0.55); font-size: 12px; }

    /* post typography */
    .post p{ line-height:1.75; margin:12px 0; font-size:15.5px; color:rgba(230,237,243,0.92); }
    .post h2{ margin:22px 0 10px; font-size:22px; }
    .post h3{ margin:18px 0 10px; font-size:18px; }
    .post ul, .post ol{ padding-left:20px; margin:10px 0 16px; }
    .post li{ margin:6px 0; line-height:1.7; }
    .post hr{ border:0; height:1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.18), transparent); margin: 22px 0; }
    .post blockquote{ margin:16px 0; padding:12px 14px; border-left:4px solid rgba(121,192,255,0.45); background: rgba(121,192,255,0.08); border-radius:14px; }
    .post pre{ white-space:pre-wrap; background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.10); padding: 12px 14px; border-radius: 14px; }
    .post img{ display:block; width:100%; height:auto; border-radius:16px; border:1px solid rgba(255,255,255,0.10); margin: 14px 0 10px; }
    .imgcap{ margin-top:-2px; margin-bottom:14px; color:rgba(230,237,243,0.65); font-size:12.5px; text-align:center; }
    .backlink{ display:inline-flex; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.03); color:rgba(230,237,243,0.80); }
  </style>

  <!-- marked는 있으면 쓰고, 없으면 fallback -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <h1><a href="./">hy blog</a></h1>
        <a href="https://github.com/weadsip12-hub/hy" target="_blank" rel="noreferrer">GitHub</a>
      </div>
      <p class="sub">posts.json을 읽어서 목록을 만들고, 클릭하면 마크다운을 불러오는 단순 블로그</p>
      <div class="controls">
        <input id="q" placeholder="검색 (제목/태그)" />
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="view"></div>
  </main>

  <footer>
    <div class="wrap">© hy • GitHub Pages</div>
  </footer>

<script>
(() => {
  const view = document.getElementById('view');
  const q = document.getElementById('q');

  const BASE = (() => {
    const parts = location.pathname.split('/').filter(Boolean);
    return parts.length ? `/${parts[0]}` : '';
  })();

  const esc = (s) => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function showError(msg){
    view.innerHTML = `<div class="empty">에러:\n${esc(String(msg))}\n\nBASE=${esc(BASE)}\npath=${esc(location.pathname)}\nhash=${esc(location.hash)}\n</div>`;
  }

  function renderList(posts, keyword=''){
    const k = keyword.trim().toLowerCase();
    const filtered = posts.filter(p => {
      if(!k) return true;
      const hay = (String(p.title||'') + ' ' + (p.tags||[]).join(' ')).toLowerCase();
      return hay.includes(k);
    });

    if(filtered.length === 0){
      view.innerHTML = `<div class="empty">검색 결과가 없어.</div>`;
      return;
    }

    view.innerHTML = filtered.map(p => `
      <div class="card">
        <div><a href="#/post/${encodeURIComponent(p.file)}"><strong>${esc(p.title || p.file)}</strong></a></div>
        <div class="meta">
          <span>${esc(p.date || '')}</span>
          ${(p.tags||[]).map(t => `<span class="badge">${esc(t)}</span>`).join('')}
        </div>
      </div>
    `).join('');
  }

  async function loadPosts(){
    const res = await fetch('./posts.json', { cache:'no-store' });
    if(!res.ok) throw new Error(`posts.json fetch 실패: status=${res.status}`);
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error(`posts.json이 배열이 아님: ${typeof data}`);

    const posts = data.filter(x => x && typeof x === 'object');
    posts.sort((a,b) => String(b.date||'').localeCompare(String(a.date||'')));
    return posts;
  }

  function normalizeMarkdown(md){
    md = md.replace(/^---[\s\S]*?---\s*/m, '');
    md = md.replace(/!\[([^\]]*)\]\(\(([^)]+)\)\)/g, '![$1]($2)');

    md = md.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (m, alt, path) => {
      const raw = (path || '').trim();
      if (/^https?:\/\//i.test(raw)) return m;

      let p = raw.replace(/^["']|["']$/g, '');
      if (p.startsWith('./')) p = p.slice(2);

      let finalUrl;
      if (p.startsWith('/blog/')) finalUrl = `${BASE}${p}`;
      else if (p.startsWith('blog/')) finalUrl = `${BASE}/${p}`;
      else if (p.startsWith('assets/')) finalUrl = `${BASE}/blog/${p}`;
      else finalUrl = `${BASE}/${p}`;

      finalUrl = encodeURI(finalUrl);
      return `![${alt}](${finalUrl})`;
    });

    return md;
  }

  function mdToHtml(md){
    if (window.marked && typeof window.marked.parse === 'function') {
      return window.marked.parse(md);
    }
    // marked 로딩 실패해도 죽지 않게 fallback
    return `<pre>${esc(md)}</pre>`;
  }

  async function renderPost(file){
    const url = `${BASE}/blog/posts/${file}`;
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok){
      view.innerHTML = `<div class="empty">포스트 fetch 실패: ${esc(file)} (status=${res.status})\nURL=${esc(url)}</div>`;
      return;
    }

    let md = await res.text();
    md = normalizeMarkdown(md);

    const html = mdToHtml(md);
    view.innerHTML = `
      <div class="card post">
        <div style="margin-bottom:12px;"><a class="backlink" href="#/">← 목록으로</a></div>
        <div>${html}</div>
      </div>
    `;

    // 이미지 캡션(alt 있으면)
    view.querySelectorAll('img').forEach(img => {
      const alt = (img.getAttribute('alt') || '').trim();
      if (!alt) return;
      const cap = document.createElement('div');
      cap.className = 'imgcap';
      cap.textContent = alt;
      img.insertAdjacentElement('afterend', cap);
    });

    window.scrollTo(0,0);
  }

  function getRoute(){
    const h = location.hash || '#/';
    const m = h.match(/^#\/post\/(.+)$/);
    return m ? { type:'post', file: decodeURIComponent(m[1]) } : { type:'list' };
  }

  let POSTS = [];

  async function router(){
    const route = getRoute();
    if(route.type === 'post') await renderPost(route.file);
    else renderList(POSTS, q.value);
  }

  // 전역 에러도 화면에 표시
  window.addEventListener('error', (e) => showError(e.message || e.error || e));
  window.addEventListener('unhandledrejection', (e) => showError(e.reason || e));

  (async () => {
    try{
      POSTS = await loadPosts();
      q.addEventListener('input', () => renderList(POSTS, q.value));
      window.addEventListener('hashchange', router);
      await router();
    } catch(e){
      showError(e.message || e);
    }
  })();
})();
</script>
</body>
</html>
